<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>STAGE - Quick Geometry Viewer</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script type="text/javascript" src="libs/d3.min.js"></script>
        <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
        <script type='text/javascript' src='libs/jquery.min.js'></script>
        <style>
            .map {
                border-style: solid;
                border-width: 1px;
                border-color: #ccc;
            }
        </style>
    </head>

    <body>
        <div id="map"></div>
        <script>
            var width = Math.max(960, window.innerWidth) - 30,
                    height = Math.max(500, window.innerHeight) - 30;
            var map = void 0;
            var mapData = void 0;
            var leafletMap;
            var mapnik;
            var dataG;

//            loadScript();
            function loadScript() {

                var body = d3.select("body");
                body.select("#map").style("width", width + "px").style("height", height + "px");
                leafletMap = L.map('map');
                mapnik = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                    maxZoom: 25,
                    maxNativeZoom: 18
                });
                var esri_world = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri',
                    maxZoom: 25,
                    maxNativeZoom: 18
                });
                var baseMaps = {
                    "mapnik": mapnik,
                    "esri_world": esri_world,
                };
                L.control.layers(baseMaps).addTo(leafletMap);
                leafletMap.setView([0.0, 0.0], 2);
                leafletMap._initPathRoot();
                leafletMap.on('moveend', function () {
                    checkData(false);
                });

                var mapSvg = d3.select("#map").select("svg");
                dataG = mapSvg.append("g");

//                d3.json("geoms.json", function (data) {

                checkData(true);
                mapnik.addTo(leafletMap);


//                });
            }

            function project(x, y) {
                var point = leafletMap.latLngToLayerPoint(new L.LatLng(y, x));
                return point;
            }

            function checkData(fitData) {
                var zoom = leafletMap.getZoom();

                var type = 1;
                if (zoom > 17) {
                    type = 2;
                }

                var bb = leafletMap.getBounds();

                var w = bb.getWest();
                var e = bb.getEast();
                var s = bb.getSouth();
                var n = bb.getNorth();


                // 1=overview, 2=cells, 3=points
                var dataStr = getJsonData(type, s, n, w, e, zoom);
                if (!dataStr)
                    return;
                var json = JSON.parse(dataStr);

                var minVal = json.vmin;
                var maxVal = json.vmax;

                var colorScale = d3.scale.linear() // <-A
                        .domain([minVal, maxVal])
                        .range(["green", "red"]);

                var rects = dataG.selectAll("rect")
                        .data(json.data);

                rects.enter()
                        .append("rect");

                rects
                        .attr("x", function (d) {
                            return project(d.x1, d.y1).x;
                        })
                        .attr("y", function (d) {
                            return project(d.x2, d.y2).y;
                        })
                        .attr("width", function (d) {
                            var x1 = project(d.x1, d.y1).x;
                            var x2 = project(d.x2, d.y2).x;
                            var w = x2 - x1;
                            if (w <= 0)
                                w = 1;
                            return w;
                        })
                        .attr("height", function (d) {
                            var y1 = project(d.x1, d.y1).y;
                            var y2 = project(d.x2, d.y2).y;
                            var h = y1 - y2;
                            if (h <= 0)
                                h = 1;
                            return h;
                        })
                        .style("stroke", function (d) {
                            if (d.l) {
                                return colorScale(d.v);
                            }
                        })
                        .style("stroke-width", function (d) {
                            if (d.l) {
                                return 2;
                            }
                        })
                        .style("fill", function (d) {
                            return colorScale(d.v);
                        })
                        .style("fill-opacity", 0.5);

                rects.exit().remove();
                if (fitData) {
                    var southWest = L.latLng(json.ymin, json.xmin),
                            northEast = L.latLng(json.ymax, json.xmax),
                            fitBounds = L.latLngBounds(southWest, northEast);
//                    leafletMap.fitBounds([
//                        [json.ymin, json.xmin],
//                        [json.ymax, json.xmax]
//                    ]);
//                    fitBounds = gjson.getBounds();
                    leafletMap.fitBounds(fitBounds);
                }
            }

        </script>
    </body>